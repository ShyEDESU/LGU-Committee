<?php
/**
 * Permission Helper
 * Manages role-based access control
 */
require_once __DIR__ . '/UserHelper.php';

/**
 * Role definitions
 */
if (!function_exists('getRoles')) {
    function getRoles()
    {
        return [
            1 => 'Super Admin',
            2 => 'Admin',
            3 => 'Committee Chairman',
            4 => 'Vice Committee Chairman',
            5 => 'User'
        ];
    }
}

/**
 * Permission matrix
 */
if (!function_exists('getPermissionMatrix')) {
    function getPermissionMatrix()
    {
        return [
            'Super Admin' => [
                'committees' => ['create', 'read', 'update', 'delete', 'manage_all'],
                'meetings' => ['create', 'read', 'update', 'delete', 'approve', 'manage_all'],
                'referrals' => ['create', 'read', 'update', 'delete', 'approve', 'manage_all'],
                'action_items' => ['create', 'read', 'update', 'delete'],
                'reports' => ['create', 'read', 'update', 'delete', 'publish'],
                'users' => ['create', 'read', 'update', 'delete'],
                'settings' => ['read', 'update'],
                'audit_logs' => ['read'],
                'agendas' => ['create', 'read', 'update', 'delete', 'manage_all']
            ],
            'Admin' => [
                'committees' => ['create', 'read', 'update', 'delete', 'manage_all'],
                'meetings' => ['create', 'read', 'update', 'delete', 'approve', 'manage_all'],
                'referrals' => ['create', 'read', 'update', 'delete', 'approve', 'manage_all'],
                'action_items' => ['create', 'read', 'update', 'delete'],
                'reports' => ['create', 'read', 'update', 'delete', 'publish'],
                'users' => ['create', 'read', 'update', 'delete'],
                'settings' => ['read', 'update'],
                'audit_logs' => ['read'],
                'agendas' => ['create', 'read', 'update', 'delete', 'manage_all']
            ],
            'Committee Chairman' => [
                'committees' => ['create', 'read', 'update'],
                'meetings' => ['create', 'read', 'update'],
                'referrals' => ['create', 'read', 'update'],
                'action_items' => ['create', 'read', 'update'],
                'reports' => ['create', 'read', 'update', 'publish'],
                'users' => [],
                'settings' => [],
                'agendas' => ['create', 'read', 'update']
            ],
            'Vice Committee Chairman' => [
                'committees' => ['read', 'update'],
                'meetings' => ['create', 'read', 'update'],
                'referrals' => ['read', 'update'],
                'action_items' => ['create', 'read', 'update'],
                'reports' => ['create', 'read', 'update'],
                'users' => [],
                'settings' => [],
                'agendas' => ['read', 'update']
            ],
            'User' => [
                'committees' => ['read'],
                'meetings' => ['read'],
                'referrals' => ['read'],
                'action_items' => ['read', 'update'], // Can update own action items
                'reports' => ['read'],
                'users' => [],
                'settings' => [],
                'agendas' => ['read']
            ]
        ];
    }
}

/**
 * Check if user has permission
 */
function hasPermission($userId, $module, $action)
{
    // Get user role
    $user = UserHelper_getUserById($userId);
    if (!$user) {
        return false;
    }

    $roleName = $user['role_name'] ?? 'Public';

    // Normalize role names for matrix lookup
    if ($roleName === 'Super Administrator')
        $roleName = 'Super Admin';
    if ($roleName === 'Administrator')
        $roleName = 'Admin';

    $matrix = getPermissionMatrix();

    if (!isset($matrix[$roleName])) {
        return false;
    }

    if (!isset($matrix[$roleName][$module])) {
        return false;
    }

    $result = in_array($action, $matrix[$roleName][$module]);

    // DEBUG: Only for users module to avoid spam
    if ($module === 'users') {
        error_log("Permission Check: UserID=$userId, Role=$roleName, Module=$module, Action=$action, Result=" . ($result ? 'TRUE' : 'FALSE'));
    }

    return $result;
}

/**
 * Get role permissions
 */
function getRolePermissions($roleId)
{
    $roles = getRoles();
    $roleName = $roles[$roleId] ?? null;

    if (!$roleName) {
        return [];
    }

    $matrix = getPermissionMatrix();
    return $matrix[$roleName] ?? [];
}

/**
 * Can create
 */
function canCreate($userId, $module)
{
    return hasPermission($userId, $module, 'create');
}

/**
 * Can read
 */
function canRead($userId, $module)
{
    return hasPermission($userId, $module, 'read');
}

/**
 * Can update
 */
function canUpdate($userId, $module)
{
    return hasPermission($userId, $module, 'update');
}

/**
 * Can delete
 */
function canDelete($userId, $module, $itemId = null)
{
    // First check matrix permission
    if (!hasPermission($userId, $module, 'delete')) {
        return false;
    }

    // If no specific item, we just check general permission
    if ($itemId === null) {
        return true;
    }

    // Admins can delete anything they have permission for
    $user = UserHelper_getUserById($userId);
    if ($user && ($user['role_name'] === 'Super Admin' || $user['role_name'] === 'Admin')) {
        return true;
    }

    // Ownership checks for specific records
    if ($module === 'committees') {
        require_once __DIR__ . '/CommitteeHelper.php';
        $committee = getCommitteeById($itemId);
        if ($committee) {
            // Only Chairperson can delete (or Admins handled above)
            return ($userId == ($committee['chairperson_id'] ?? 0));
        }
    }

    // Default to false for non-admins deleting specific items unless handled above
    return false;
}

/**
 * Can approve
 */
function canApprove($userId, $module)
{
    return hasPermission($userId, $module, 'approve');
}

/**
 * Can publish
 */
function canPublish($userId, $module)
{
    return hasPermission($userId, $module, 'publish');
}

/**
 * Check if user can edit specific item (ownership check)
 */
function canEdit($userId, $module, $itemId)
{
    // First check if user has update permission
    if (!canUpdate($userId, $module)) {
        return false;
    }

    // Admins can edit anything
    $user = UserHelper_getUserById($userId);
    if ($user && ($user['role_name'] === 'Super Admin' || $user['role_name'] === 'Admin')) {
        return true;
    }

    // Ownership checks
    if ($module === 'committees') {
        require_once __DIR__ . '/CommitteeHelper.php';
        $committee = getCommitteeById($itemId);
        if ($committee) {
            // Check if user is Chair, Vice Chair, or Secretary
            return (
                $userId == ($committee['chairperson_id'] ?? 0) ||
                $userId == ($committee['vice_chair_id'] ?? 0) ||
                $userId == ($committee['secretary_id'] ?? 0)
            );
        }
        return false;
    }

    if ($module === 'meetings') {
        require_once __DIR__ . '/MeetingHelper.php';
        $meeting = getMeetingById($itemId);
        if ($meeting) {
            require_once __DIR__ . '/CommitteeHelper.php';
            $committee = getCommitteeById($meeting['committee_id']);
            if ($committee) {
                return (
                    $userId == ($committee['chairperson_id'] ?? 0) ||
                    $userId == ($committee['vice_chair_id'] ?? 0) ||
                    $userId == ($committee['secretary_id'] ?? 0)
                );
            }
        }
        return false;
    }

    if ($module === 'referrals') {
        require_once __DIR__ . '/ReferralHelper.php';
        $referral = getReferralById($itemId);
        if ($referral) {
            require_once __DIR__ . '/CommitteeHelper.php';
            $committee = getCommitteeById($referral['committee_id']);
            if ($committee) {
                return (
                    $userId == ($committee['chairperson_id'] ?? 0) ||
                    $userId == ($committee['vice_chair_id'] ?? 0) ||
                    $userId == ($committee['secretary_id'] ?? 0)
                );
            }
        }
        return false;
    }

    // For other modules with update permission, but no specific ownership check defined
    // We default to false to be safe, or true if update permission is deemed sufficient
    // Given the issues, defaulting to false is safer.
    return false;
}

/**
 * Check if user can view module
 */
function canViewModule($userId, $module)
{
    return canRead($userId, $module);
}
?>